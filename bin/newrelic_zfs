#!/usr/bin/env ruby

require 'rubygems'
require 'bundler/setup'

require 'newrelic_plugin'
require 'trollop'

require 'collector'
require 'newrelic_zfs/config'

module ZfsAgent

  class Agent < NewRelic::Plugin::Agent::Base
    @collector = Collector.new

    agent_guid 'com.tomreay.newrelic-zfs'
    agent_version '1.0.0'
    agent_config_options :instance_name, :print_metrics
    agent_human_labels("ZFS Agent") { instance_name }

    def poll_cycle
      metrics = @collector.collect_stats
      metrics.each do |metric|
        if print_metrics
          puts 'Reporting metric named ' + metric.newrelic_name + ' with value ' + stat.value.to_s + ' and unit ' + stat.unit
        end
        report_metric metric.newrelic_name, stat.unit, stat.value
      end
    end
  end

  opts = Trollop::options do
    opt :config_file, "Config file", :type => :string
  end

  config_file_path = ZfsConfig::get_config_location(ARGV[0])
  if config_file_path.nil?
    exit
  end

  NewRelic::Plugin::Config::config_file = config_file_path
  NewRelic::Plugin::Setup.install_agent :zfs, ZfsAgent
  NewRelic::Plugin::Run.setup_and_run

  puts 'Newrelic ZFS Agent started'
end